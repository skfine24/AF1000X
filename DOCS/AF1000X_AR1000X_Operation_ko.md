# AF1000X(스마트드론) / AR1000X(드론컨트롤러) 동작 기술문서 (KO)

## 1. 문서 개요
- 대상: AF1000X 스마트드론, AR1000X 드론컨트롤러
- 목적: 전원, 페어링, 링크, FHSS, 입력 소스 전환, 안전 동작, PC 허브 제어 절차를 제품 매뉴얼 스타일로 정리한다.
- 근거: `AR1000X_Main.ino`, `AR1000X_Controller_Operation.md`, `AR1000X_Serial_Command_Reference.md`, 사용자 제공 동작 시퀀스

## 2. 용어/명칭
- AF1000X: 스마트드론(수신/비행체)
- AR1000X: 드론컨트롤러(송신/PC 허브)

## 3. 안전 및 주의
- PC 제어는 `ARM 1` 이후에만 수행한다.
- 비상 정지는 `EMERGENCY` 또는 스틱 비상 콤보로 수행한다.
- 링크 손실 발생 시 AF1000X는 페일세이프 규격에 따라 자동 착륙/모터 컷을 수행한다.
- 자동 이륙/오토튠 중에는 스틱 입력 간섭을 최소화한다.
- 페어링 중에는 AR1000X와 AF1000X의 전원을 안정적으로 유지한다.

## 4. 시스템 구성
```
PC (USB Serial 115200)
 -> AR1000X 드론컨트롤러 (RP2040, nRF24L01+)
 -> RF (FHSS)
 -> AF1000X 스마트드론
```
- AR1000X는 안전 게이트로 동작하며, `ARM 1` 이후에만 PC 제어를 허용한다.
- `JOY` 스트림이 200ms 이상 끊기면 스틱 입력으로 자동 복귀한다.

## 5. AR1000X 드론컨트롤러 동작

## 5.1 전원 인가 및 부팅
1. USB CDC 115200을 초기화하고 USB 제품명을 `SYUBEA AF1000X Controller`로 설정한다.
2. 부팅 시 버튼 홀드 상태에 따라 모드 및 초기 동작이 결정된다.
3. RF 모듈을 `PAIR_CHANNEL=76`, `RF24_250KBPS`, `PA_LOW`로 초기화하고 TX 파이프를 연다.
4. FHSS 홉 테이블을 EEPROM에서 로드한다.
5. EEPROM에 테이블이 없으면 스캔 결과로 `hopTable`을 구성한다.
6. 부팅 중 페어링 버튼이 홀드되어 있으면 즉시 페어링을 수행한다.

## 5.2 페어링/바인딩/링크
- 페어링은 `PAIR_CHANNEL=76`에서 `LinkPayload`를 반복 전송해 ACK를 받을 때까지 진행한다.
- `LinkPayload`에는 컨트롤러 이름(`AF1000X`), TX 주소, 홉 테이블, 플래그, CRC가 포함된다.
- 페어링 성공 시 `linkReady=true`가 된다.
- `boundOK`는 실제 제어 패킷 전송 성공 시에만 true가 된다. 페어링만으로 바인딩이 보장되지는 않는다.
- `linkReady=false` 상태에서는 500ms 간격으로 링크 페이로드를 백그라운드 재전송한다.
- 새 홉 테이블이 준비되어 있으면 연결 성공 후 적용하고 EEPROM에 저장한다.

## 5.3 FHSS 동작
- 스캔 범위: 채널 5~80 (2405~2480 MHz)
- 샘플링: 채널당 4회 RPD 측정
- 선택: 간섭이 가장 적은 채널 12개(`HOP_MAX=12`)
- 홉 슬롯: 20ms (`HOP_SLOT_MS=20`)
- 홉 인덱스는 전송 패킷에 포함된다.

## 5.4 입력 소스 전환 규칙
- 입력 경로는 `stickSig`(물리 스틱)과 `pcSig`(PC)로 분리된다.
- 스틱이 활성 상태이면 PC 오버라이드는 즉시 해제된다.
- PC 입력은 `ARM 1` 이후에만 유효하며, 미 ARM 상태에서는 `IGN`을 반환한다.
- `JOY` 스트림이 200ms 이상 끊기면 스틱 제어로 자동 복귀한다.

## 5.5 버튼/모드 동작 요약
- 버튼 기능 및 GPIO 매핑은 부록 B를 기준으로 한다.
- 속도 모드, 헤드리스, 옵티컬 플로우, 트림 모드는 런타임 토글 방식으로 동작한다.
- 자동 이륙/착륙 및 자이로 초기화는 AUX1 펄스로 요청된다.

## 5.6 안전/비상 동작
- `EMERGENCY`는 즉시 스로틀 컷을 수행하고 가능한 즉시 패킷 전송을 시도한다.
- `STOP`은 `EMERGENCY`와 동일하게 처리된다.
- 스틱 비상 콤보는 양쪽 스틱을 하단 대각선으로 2초 유지하면 발동된다.
- 비상 발동 시 PC 오버라이드는 해제되고 중립 패킷이 전송된다.

## 5.7 PC 허브 제어
- 통신: USB CDC 115200, 줄바꿈 `\r` 또는 `\n`, 대소문자 무관
- 핵심 명령: `ARM 1`, `ARM 0`, `BIND`, `PAIR`, `JOY ...`, `TAKEOFF`, `LAND`, `SPEED 1/2/3`, `HEADLESS`, `FLOW ON/OFF`, `EMERGENCY`, `STOP`, `BAT?`, `ID?`, `DBUG`
- dd3 이동 명령: `FORWARD|BACK|LEFT|RIGHT|UP|DOWN|CW|CCW <power> <time_ms>`
- 응답 코드: `OK`, `IGN`, `ERR`

## 6. AF1000X 스마트드론 동작

## 6.1 전원 인가 및 페어링 시퀀스
1. AF1000X 전원을 공급한 뒤 위아래를 뒤집는다.
2. 이때 AF1000X의 LED1~4가 순차 점등된다.
3. AR1000X에서 `GPIO15` 버튼을 누른 상태로 전원을 켠다.
4. AR1000X의 LED1(LED1_POWER)이 점멸한다.
5. 페어링 완료 시 양쪽 LED가 지속 점등된다.

## 6.2 LED 표시 규격(확정 스펙)
- LED1~4는 바인딩 상태 표시용으로 사용한다.
- 순차 점등은 LED1 → LED2 → LED3 → LED4 순으로 진행한다.
- 순차 점등 간격은 250ms를 기준으로 한다.
- 바인딩 완료 시 LED1~4는 지속 점등 상태를 유지한다.

## 6.3 자동 이륙 및 오토튠 규격(확정 스펙)
- 적용 목적: PID 셋팅
- 적용 시점: 자동 이륙 요청(AUX1 펄스) 수신 시
- 전체 진행 시간: 약 30초
- 목표 고도: 약 1m
- 보정 항목: 상승 중 PWM 값 교정
- 완료 동작: 오토튠 종료 후 정상 비행 모드로 전환

## 6.4 링크 손실(페일세이프) 규격(설계 확정)
감지 조건: 마지막 유효 제어 패킷 수신 후 500ms 경과.
동작 단계:
1. 스로틀을 1초 동안 선형으로 0까지 램프다운
2. 1~3초 구간에서 자동 착륙 모드 유지(완만 하강)
3. 3초 경과 시 모터 컷
표시: 링크 손실 LED 패턴은 부록 D를 따른다.

## 6.5 제어 신호 수신 및 모드
- AF1000X는 AR1000X가 전송한 스틱 또는 PC 제어 신호를 수신한다.
- `AUX1`은 이륙/착륙, 자이로 초기화, LED 단계 변경, 서보 토글 요청에 사용된다.
- `AUX2`는 헤드리스 및 옵티컬 플로우 상태를 표시하는 비트필드로 사용된다.

## 6.6 센서/출력 구성
- RF: nRF24L01+
- 거리 센서: VL53L1X
- IMU: ICM45686
- LED: WS2812C (GPIO17)
- 서보: GPIO36 (0~180도, 900~2000us)

## 6.7 운용 중 주의 사항
- 자동 이륙/오토튠 중에는 스틱 입력 간섭을 최소화한다.
- 페어링 중에는 AR1000X와 AF1000X의 전원을 안정적으로 유지한다.

## 7. 운용 시나리오

## 7.1 최초 바인딩
1. AR1000X를 `GPIO15` 홀드 상태로 부팅해 페어링을 수행한다.
2. LED1 고정 ON 상태가 될 때까지 대기한다.
3. AF1000X가 응답하면 `boundOK`가 true가 되고 LED1이 고정된다.

## 7.2 스틱 운용
1. 스틱 입력이 들어오면 PC 오버라이드가 해제된다.
2. 헤드리스/플로우/트림은 버튼 토글로 즉시 반영된다.

## 7.3 PC 허브 운용
1. `ARM 1`로 PC 제어를 활성화한다.
2. `JOY` 스트림 또는 dd3 명령으로 제어한다.
3. 통신이 200ms 이상 끊기면 스틱 제어로 자동 복귀한다.

## 7.4 비상 정지
1. `EMERGENCY` 또는 `STOP` 명령을 전송한다.
2. 스틱 비상 콤보(2초 유지)로도 즉시 모터 컷을 수행한다.

## 8. 부록

## 부록 A. 도면/이미지

![Figure A-1. System schematic](SCH_Schematic1_1-P1_2026-02-03.png)
Figure A-1. 회로도 전체도. 전원/MCU/RF 연결 관계 참고.

![Figure A-2. RP2040 pin summary](_crop_rp_pins.png)
Figure A-2. RP2040 핀 요약. GPIO 배치 확인.

![Figure A-3. Joystick wiring](_crop_joystick.png)
Figure A-3. 조이스틱 배선 요약. 축/센터 기준 참고.

![Figure A-4. MUX wiring](_crop_mux.png)
Figure A-4. MUX 기본 배선. ADC 다중화 경로 확인.

![Figure A-5. MUX wiring detail](_crop_mux2.png)
Figure A-5. MUX 세부 배선. S0/ADC 연결 참고.

## 부록 B. AR1000X 핀맵(요약)
| 구분 | 신호 | GPIO | 비고 |
| --- | --- | --- | --- |
| RF | RF_CE | 6 | nRF24L01+ CE |
| RF | RF_CSN | 5 | nRF24L01+ CSN |
| MUX | MUX_S0 | 22 | 채널 선택 |
| MUX | MUX_S1 | - | GND 고정(미사용) |
| MUX | MUX_S2 | - | GND 고정(미사용) |
| MUX | MUX_ADC | 29 | ADC 입력 |
| ADC | ADC_THROTTLE | 26 | 스로틀 |
| ADC | ADC_YAW | 27 | 요(Yaw) |
| ADC | ADC_PITCH | 28 | 피치(Pitch) |
| BTN | BTN_PAIR_SPEED | 15 | 페어링/속도 |
| BTN | BTN_AUTO | 11 | 자동 이륙/자이로 |
| BTN | BTN_TRIM_MODE | 14 | 트림/모드 |
| BTN | BTN_HEADLESS | 13 | 헤드리스 |
| BTN | BTN_FLOW_TOGGLE | 10 | 플로우/ID 재생성 |
| BTN | BTN_LED_SERVO | 12 | LED/서보 |
| LED | LED1_POWER | 25 | 전원/바인딩 |
| LED | LED2_HEADLESS | 23 | 헤드리스 |
| LED | LED3_TRIM | 24 | 트림 |

## 부록 C. AR1000X LED 타이밍
| LED | 상태 | 패턴 | 주기 |
| --- | --- | --- | --- |
| LED1(POWER) | 저전압 | 점멸 | 0.5s |
| LED1(POWER) | 미바인딩 | 점멸 | 1.0s |
| LED1(POWER) | 바인딩 완료 | 고정 ON | - |
| LED1(POWER) | 페어링 중 | 점멸 | 0.25s |
| LED2(HEADLESS) | ON | 점멸 | 1.0s |
| LED2(HEADLESS) | OFF | 소등 | - |
| LED3(TRIM) | ON | 점멸 | 0.5s |
| LED3(TRIM) | OFF | 소등 | - |

## 부록 D. AF1000X LED 타이밍(확정 스펙)
| 상태 | LED1 | LED2 | LED3 | LED4 | 비고 |
| --- | --- | --- | --- | --- | --- |
| 바인딩 준비 | 순차 점등 | 순차 점등 | 순차 점등 | 순차 점등 | 250ms 간격 |
| 바인딩 타임아웃(30s) | 동시 점멸 | 동시 점멸 | 동시 점멸 | 동시 점멸 | 0.5s 주기, 5s 후 바인딩 준비로 복귀 |
| 바인딩 완료 | 지속 점등 | 지속 점등 | 지속 점등 | 지속 점등 | - |
| 링크 손실(비행 중) | 동시 점멸 | 동시 점멸 | 동시 점멸 | 동시 점멸 | 1.0s 주기, 페일세이프 동작 중 |

## 9. 개선점 로그 및 개선안
| 구분 | 개선 항목 | 개선안 | 상태 |
| --- | --- | --- | --- |
| 안전/페일세이프 | 링크 손실 동작 정의 | 링크 손실 시 스로틀 램프다운/자동 착륙/모터 컷 규격 확정 | 규격 확정(적용 예정) |
| 안전/페일세이프 | 비상 상태 피드백 | 비상 발동 시 LED 패턴 또는 버저 피드백 추가 | 설계 확정 필요 |
| LED/오토튠 | LED 오류 패턴 | 페어링 타임아웃/링크 손실 LED 패턴 정의 | 규격 확정(적용 예정) |
| LED/오토튠 | 오토튠 실패 처리 | 실패 시 자동 착륙/모터 컷 동작 정의 | 설계 확정 필요 |
| 페어링/링크 | 재시도 정책 | 페어링 재시도 횟수/타임아웃 명문화 | 설계 확정 필요 |
| 페어링/링크 | 품질 지표 | 페어링 성공률/링크 품질 로그 추가 | 개선 제안 |
| 문서/표현 | 제품 매뉴얼 톤 | 문서 전반 구조/표현 정돈 | 완료 |
| 문서/부록 | 이미지 부록 | 캡션/설명 포함 이미지 부록화 | 완료 |
| 문서/언어 | 영문 매뉴얼 | 영문 버전 추가 | 완료 |
